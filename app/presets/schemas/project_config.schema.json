{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://klippconfig.local/schema/project_config.schema.json",
  "title": "KlippConfig Project Config",
  "type": "object",
  "required": [
    "schema_version",
    "output_layout",
    "preset_id",
    "board",
    "dimensions",
    "probe",
    "thermistors",
    "motion_profile",
    "macro_packs",
    "addons",
    "toolhead",
    "leds",
    "advanced_overrides",
    "machine_attributes",
    "addon_configs",
    "section_map"
  ],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "integer",
      "const": 2
    },
    "output_layout": {
      "type": "string",
      "enum": ["source_tree", "modular"]
    },
    "preset_id": {
      "type": "string",
      "minLength": 3
    },
    "board": {
      "type": "string",
      "minLength": 3
    },
    "dimensions": {
      "type": "object",
      "required": ["x", "y", "z"],
      "additionalProperties": false,
      "properties": {
        "x": { "type": "integer", "minimum": 50 },
        "y": { "type": "integer", "minimum": 50 },
        "z": { "type": "integer", "minimum": 50 }
      }
    },
    "probe": {
      "type": "object",
      "required": ["enabled", "type"],
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "type": { "type": ["string", "null"] }
      }
    },
    "thermistors": {
      "type": "object",
      "required": ["hotend", "bed"],
      "additionalProperties": false,
      "properties": {
        "hotend": { "type": "string", "minLength": 1 },
        "bed": { "type": "string", "minLength": 1 }
      }
    },
    "motion_profile": {
      "type": "string",
      "const": "safe"
    },
    "macro_packs": {
      "type": "array",
      "uniqueItems": true,
      "items": {
        "type": "string",
        "enum": ["core_maintenance", "qgl_helpers", "filament_ops"]
      }
    },
    "addons": {
      "type": "array",
      "uniqueItems": true,
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9][a-z0-9._-]{2,}$"
      }
    },
    "toolhead": {
      "type": "object",
      "required": ["enabled", "board", "canbus_uuid"],
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "board": { "type": ["string", "null"], "minLength": 3 },
        "canbus_uuid": { "type": ["string", "null"], "minLength": 4 }
      }
    },
    "leds": {
      "type": "object",
      "required": [
        "enabled",
        "pin",
        "chain_count",
        "color_order",
        "initial_red",
        "initial_green",
        "initial_blue"
      ],
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "pin": { "type": ["string", "null"], "minLength": 2 },
        "chain_count": { "type": "integer", "minimum": 1, "maximum": 256 },
        "color_order": {
          "type": "string",
          "enum": ["RGB", "GRB", "BRG", "BGR"]
        },
        "initial_red": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "initial_green": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "initial_blue": { "type": "number", "minimum": 0.0, "maximum": 1.0 }
      }
    },
    "advanced_overrides": {
      "type": "object",
      "additionalProperties": {
        "type": ["string", "number", "boolean", "null"]
      }
    },
    "machine_attributes": {
      "type": "object",
      "required": [
        "root_file",
        "include_graph",
        "printer_limits",
        "mcu_map",
        "stepper_sections",
        "driver_sections",
        "probe_sections",
        "leveling_sections",
        "thermal_sections",
        "fan_sections",
        "sensor_sections",
        "resonance_sections"
      ],
      "additionalProperties": false,
      "properties": {
        "root_file": { "type": "string", "minLength": 1 },
        "include_graph": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "printer_limits": {
          "type": "object",
          "required": [
            "max_velocity",
            "max_accel",
            "max_z_velocity",
            "max_z_accel",
            "square_corner_velocity"
          ],
          "additionalProperties": false,
          "properties": {
            "max_velocity": { "type": "number", "exclusiveMinimum": 0 },
            "max_accel": { "type": "number", "exclusiveMinimum": 0 },
            "max_z_velocity": { "type": ["number", "null"], "exclusiveMinimum": 0 },
            "max_z_accel": { "type": ["number", "null"], "exclusiveMinimum": 0 },
            "square_corner_velocity": { "type": "number", "exclusiveMinimum": 0 }
          }
        },
        "mcu_map": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "required": ["serial", "canbus_uuid", "restart_method"],
            "additionalProperties": false,
            "properties": {
              "serial": { "type": ["string", "null"] },
              "canbus_uuid": { "type": ["string", "null"] },
              "restart_method": { "type": ["string", "null"] }
            }
          }
        },
        "stepper_sections": { "$ref": "#/$defs/section_value_map" },
        "driver_sections": { "$ref": "#/$defs/section_value_map" },
        "probe_sections": { "$ref": "#/$defs/section_value_map" },
        "leveling_sections": { "$ref": "#/$defs/section_value_map" },
        "thermal_sections": { "$ref": "#/$defs/section_value_map" },
        "fan_sections": { "$ref": "#/$defs/section_value_map" },
        "sensor_sections": { "$ref": "#/$defs/section_value_map" },
        "resonance_sections": { "$ref": "#/$defs/section_value_map" }
      }
    },
    "addon_configs": {
      "type": "object",
      "required": ["kamp", "stealthburner_leds", "timelapse"],
      "additionalProperties": false,
      "properties": {
        "kamp": { "$ref": "#/$defs/addon_package" },
        "stealthburner_leds": { "$ref": "#/$defs/addon_package" },
        "timelapse": { "$ref": "#/$defs/addon_package" }
      }
    },
    "section_map": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/section_value_map"
      }
    }
  },
  "$defs": {
    "section_value_map": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": { "type": "string" }
      }
    },
    "addon_package": {
      "type": "object",
      "required": ["enabled", "include_files", "sections"],
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "include_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "sections": { "$ref": "#/$defs/section_value_map" }
      }
    }
  }
}
